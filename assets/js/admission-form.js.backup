// Admission Form Firebase Integration
import { admissionHelper, analyticsHelper } from './firebase-config.js';

// Log page view
analyticsHelper.logPageView('admission_form');

// Check if editing existing student
const urlParams = new URLSearchParams(window.location.search);
const editingStudentId = urlParams.get('studentId');
let isEditMode = !!editingStudentId;

let currentStep = 0;
const steps = document.querySelectorAll('.form-step');
const progressSteps = document.querySelectorAll('.progress-step');

function showStep(step) {
    steps.forEach((s, index) => {
        s.classList.toggle('active', index === step);
    });

    progressSteps.forEach((s, index) => {
        if (index < step) {
            s.classList.add('completed');
            s.classList.remove('active');
        } else if (index === step) {
            s.classList.add('active');
            s.classList.remove('completed');
        } else {
            s.classList.remove('active', 'completed');
        }
    });

    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function nextStep() {
    if (validateCurrentStep()) {
        if (currentStep < steps.length - 1) {
            currentStep++;
            showStep(currentStep);

            if (currentStep === steps.length - 1) {
                populateReview();
            }
        }
    }
}

function prevStep() {
    if (currentStep > 0) {
        currentStep--;
        showStep(currentStep);
    }
}

function validateCurrentStep() {
    const currentStepElement = steps[currentStep];
    const inputs = currentStepElement.querySelectorAll('input[required], select[required], textarea[required]');

    for (let input of inputs) {
        if (!input.value) {
            input.focus();
            alert('कृपया सभी आवश्यक फ़ील्ड भरें।');
            return false;
        }
    }
    return true;
}

function populateReview() {
    const formData = new FormData(document.getElementById('admission-form'));
    const reviewContent = document.getElementById('review-content');

    let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';

    for (let [key, value] of formData.entries()) {
        if (value && typeof value === 'string') {
            const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

            // Format DOB if key is 'dob'
            let displayValue = value;
            if (key === 'dob' && value.includes('-')) {
                const [year, month, day] = value.split('-');
                displayValue = `${day}/${month}/${year}`;
            }

            html += `
                <div class="border-b pb-2">
                    <p class="text-sm text-gray-500">${label}</p>
                    <p class="font-semibold">${displayValue}</p>
                </div>
            `;
        }
    }

    html += '</div>';
    reviewContent.innerHTML = html;
}

// Form submission with Firebase
document.getElementById('admission-form').addEventListener('submit', async function (e) {
    e.preventDefault();

    if (!document.getElementById('cert2').checked) {
        alert('कृपया नियमों और शर्तों को स्वीकार करें / Please accept the terms and conditions.');
        return;
    }

    const submitButton = document.getElementById('btn_submit');
    const originalText = submitButton.innerText;
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';

    try {
        // Collect form data
        const formData = new FormData(this);
        const data = {};

        for (let [key, value] of formData.entries()) {
            if (value instanceof File) {
                // Skip files for now, handle separately
                continue;
            }
            data[key] = value;
        }

        // Collect files - only include files that were actually selected
        const files = {};

        const birthCertFile = formData.get('birthCert');
        if (birthCertFile && birthCertFile.size > 0) {
            files.birthCertificate = birthCertFile;
        }

        const aadharCardFile = formData.get('aadharCard');
        if (aadharCardFile && aadharCardFile.size > 0) {
            files.aadharCard = aadharCardFile;
        }

        const casteCertFile = formData.get('casteCert');
        if (casteCertFile && casteCertFile.size > 0) {
            files.casteCertificate = casteCertFile;
        }

        const domicileCertFile = formData.get('domicileCert');
        if (domicileCertFile && domicileCertFile.size > 0) {
            files.domicileCertificate = domicileCertFile;
        }

        const photoFile = formData.get('photo');
        if (photoFile && photoFile.size > 0) {
            files.photo = photoFile;
        }

        console.log('Files to upload:', Object.keys(files)); // Debug log

        // Submit to Firebase
        // Map form data to backend expectations
        const formDataObj = Object.fromEntries(formData.entries());
        const mappedData = {
            student_name: formDataObj.scholarName || '',
            dob: formDataObj.dob || '',
            class: formDataObj.targetClass || '',
            father_name: formDataObj.fatherName || '',
            father_occupation: formDataObj.fatherOcc || '',
            mother_name: formDataObj.motherName || '',
            mother_occupation: formDataObj.motherOcc || '',
            mobile: formDataObj.fMobile || '',
            email: formDataObj.parentEmail || '',
            address: formDataObj.permAddress || '',

            // Other fields to keep as-is or map if needed
            ...formDataObj // Keep original keys too just in case
        };

        // Create a clean object for Firestore data by explicitly excluding File objects
        const cleanData = {};
        for (const [key, value] of Object.entries(mappedData)) {
            // Check if the value is NOT a File object
            if (!(value instanceof File)) {
                cleanData[key] = value;
            }
        }

        let result;

        // Check if editing existing student
        if (isEditMode && editingStudentId) {
            // Update existing student in students collection
            const { firestoreHelper, storageHelper } = await import('./firebase-config.js');

            const studentData = {
                studentName: mappedData.scholarName,
                rollNumber: mappedData.rollNumber || '',
                class: mappedData.class,
                dob: mappedData.dob,
                gender: mappedData.gender || '',
                fatherName: mappedData.fatherName,
                motherName: mappedData.motherName,
                mobile: mappedData.mobile,
                email: mappedData.email || '',
                address: mappedData.permAddress,
                updatedAt: new Date().toISOString()
            };

            // Handle photo upload if new photo selected
            if (files.photo) {
                const uploadResult = await storageHelper.uploadFile(files.photo, `students/${Date.now()}_${files.photo.name}`);
                if (uploadResult.success) {
                    studentData.photo = uploadResult.url;
                }
            }

            result = await firestoreHelper.updateDocument('students', editingStudentId, studentData);
        } else {
            // Create new admission (original behavior)
            result = await admissionHelper.submitAdmission(cleanData, files);
        }

        if (result.success) {
            // Log analytics event
            analyticsHelper.logEvent(isEditMode ? 'student_updated' : 'admission_submitted', {
                class: mappedData.class,
                has_documents: !!(files.birthCertificate || files.aadharCard || files.photo)
            });

            // Show success message
            if (isEditMode) {
                alert(`छात्र की जानकारी सफलतापूर्वक अपडेट हो गई है!`);
            } else {
                alert(`आपका आवेदन सफलतापूर्वक सबमिट हो गया है!\n\nआवेदन संख्या: ${result.id}\n\nहम जल्द ही आपसे संपर्क करेंगे।`);
            }

            // Clear form and localStorage
            this.reset();
            localStorage.removeItem('admission-form');

            // Check if opened from admin dashboard
            const urlParams = new URLSearchParams(window.location.search);
            const source = urlParams.get('source');

            // Redirect based on source
            if (source === 'admin') {
                // Immediate redirect for admin
                window.location.href = 'admin-dashboard.html?tab=students';
            } else {
                // Delay for public users to see success message
                setTimeout(() => {
                    window.location.href = '../index.html';
                }, 2000);
            }
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        console.error('Submission error:', error);
        alert('Submission Error: ' + error.message + '\n\nPlease try again.');

        // Re-enable button
        const submitButton = document.getElementById('btn_submit');
        submitButton.disabled = false;
        submitButton.innerHTML = '<span id="btn_submit_text">Final Submit Application</span>';
    }
});

// Make functions available globally
window.nextStep = nextStep;
window.prevStep = prevStep;

// Load existing student data if in edit mode
async function loadStudentData() {
    if (!isEditMode || !editingStudentId) return;
    try {
        const { firestoreHelper } = await import('./firebase-config.js');
        const result = await firestoreHelper.getDocument('students', editingStudentId);
        if (result.success && result.data) {
            const s = result.data;
            const setField = (name, val) => { const f = document.querySelector([name=" \]); if (f && val) f.value = val; }; setField('scholarName', s.studentName);
            if (document.getElementById('dob')) document.getElementById('dob').value = s.dob || '';
            if (document.getElementById('targetClass')) document.getElementById('targetClass').value = s.class || '';
            if (document.getElementById('fatherName')) document.getElementById('fatherName').value = s.fatherName || '';
            if (document.getElementById('motherName')) document.getElementById('motherName').value = s.motherName || '';
            if (document.getElementById('mobile')) document.getElementById('mobile').value = s.mobile || '';
            if (document.getElementById('permAddress')) document.getElementById('permAddress').value = s.address || '';
            if (s.photo && document.getElementById('photoPreview')) document.getElementById('photoPreview').src = s.photo;
        }
    } catch (error) { console.error('Error loading student data:', error); }
}
if (isEditMode) { loadStudentData(); }

